@model IPagedList<dynamic>
@{
    ViewData["Title"] = "Index";
}
<br />
<br />
<br />
<form method="get" asp-action="Index">
    <div class="form-inline form-group">
        <label class="control-label">Product Type: </label>
        <input type="text" name="type" value="@ViewData["CurrentType"]" />

        <label class="control-label">Product name: </label>
        <input type="text" name="name" value="@ViewData["CurrentName"]" />

        <label class="control-label">Page size</label>
        <input type="number" min="1" name="pageSize" value="@ViewData["CurrentSize"]" />
        <input type="submit" value="Filter" class="btn btn-default" />
    </div>
</form>

<table id="pmTable" class="table table-hover table-bordered">
    <thead>
        <tr>
            <th>Product type</th>
            <th>Product name</th>
            <th>Count</th>
            <th>Current count</th>
            <th>Unit</th>
            @if (User.IsInRole("Worker"))
            {
                <th>Select quantity</th>
                <th>Add to Basket</th>
            }
            <th>Show</th>
        </tr>
    </thead>
    <tbody>
        @if (Model.Count() == 0)
        {
            <tr><td colspan="8" class="text-center">There are no products!</td></tr>
        }
        @foreach (dynamic productManager in Model)
        {
            <tr>
                <td hidden="hidden"><input id="id" type="hidden" value="@productManager.Product.Id" /></td>
                <td>@productManager.Product.ProductType.Name</td>
                <td>@productManager.Product.Name</td>
                <td>@productManager.Count</td>
                <td class="currentCount">@productManager.CurrentCount</td>
                <td>@productManager.Product.Unit.Name</td>
                <td><input type="number" min="0" style="width:50px" name="quantity" value="0" /></td>
                <td><input type="button" value="Add" name="Add" /></td>
                <td><a asp-action="Show" asp-route-id="@productManager.Product.Id">Show</a></td>
                <td></td>
                <td></td>
            </tr>
        }
    </tbody>
</table>
<pager list="@Model" asp-route-pageSize="@ViewData["CurrentSize"]"  asp-route-type="@ViewData["CurrentType"]" asp-route-name="@ViewData["CurrentName"]" asp-controller="ProductManager" asp-action="Index"/>

@section Scripts{
    <script src="~/js/productManager.js"></script>
    <script src="https://kit.fontawesome.com/b7938c82ea.js"></script>
    <link href="~/css/jquery-confirm.min.css" rel="stylesheet" />
    <script src="~/js/jquery-confirm.min.js"></script>
    
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial.cshtml");}
    <script>
        $(() => {
            //Before adding to the cart check the quantity of product
            $("input[name='Add']").on("click", function () {
                $(this).parent().parent().addClass("select");
                let $inputQuantity = $(".select").children().find("input[name='quantity']");
                let $id = $(".select").children().children().val();
                let $currentCount = $(".select td.currentCount").html();
                let $quantity = $inputQuantity.val();
                $(this).parent().parent().removeClass();
                if (parseInt($quantity) <= parseInt($currentCount) & parseInt($quantity)!==0) {
                    $.ajax({
                        type: 'GET',
                        url: '/ProductManager/Add/' + $id + '/' + $quantity,
                        success: function (data) {
                            if (data) {
                                $.confirm({
                                    icon: 'fas fa-check-circle',
                                    title: 'Warehouse!',
                                    content: 'Product added to cart!',
                                    type: 'dark',
                                    typeAnimated: true,
                                    closeAnimation: 'rotateXR',
                                    buttons: {
                                        close: {
                                            btnClass: "btn-dark",
                                            action: function () {
                                            }
                                        }
                                    }
                                });
                                $inputQuantity.val(0);
                            }
                            else {
                                $.confirm({
                                    icon: 'fas fa-exclamation-triangle',
                                    title: 'Warehouse!',
                                    content: 'An error has occurred. Please, try again!',
                                    type: 'red',
                                    typeAnimated: true,
                                    closeAnimation: 'rotateXR',
                                    buttons: {
                                        close: {
                                            btnClass: "btn-red",
                                            action: function () {
                                            }
                                        }
                                    }
                                });
                            }
                        }
                    });
                }
                else {
                    $.confirm({
                        icon: 'fas fa-exclamation-triangle',
                        title: 'Warehouse!',
                        content: 'An error has occurred. Please, select fewer products!',
                        type: 'red',
                        typeAnimated: true,
                        closeAnimation: 'rotateXR',
                        buttons: {
                            close: {
                                btnClass: "btn-red",
                                action: function () {
                                }
                            }
                        }
                    });
                    $inputQuantity.val(0);
                }
            });
            $("input[name='quantity']").blur(function () {
                $(this).css("border", "1px solid #92a8d1");
            });
        });
    </script>
}